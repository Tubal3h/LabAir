import{p as U}from"./chunk-CYFMJ57Z.js";import{k as C,l as v}from"./chunk-H3KW6RZE.js";import{I as n,O as g,T as p,a as d,b,j as u,m as o,q as h,w as y,y as m}from"./chunk-QDANSVX3.js";var I=class c{constructor(t,e){this.api=t;this.http=e;this.baseUrl=this.api.getBaseUrl();let r=localStorage.getItem("userID");r&&this.userIdSubject.next(Number(r))}baseUrl;isLoggedSubject=new u(!1);isLogged$=this.isLoggedSubject.asObservable();userIdSubject=new u(null);userId$=this.userIdSubject.asObservable();setLoggedStatus(t){this.isLoggedSubject.next(t)}getLoggedStatus(){return this.isLoggedSubject.value}loginUser(t,e){let r=new C({"Content-Type":"application/json"}),i={email:t,password:e};return this.http.post(`${this.baseUrl}/login`,i,{headers:r})}getUserData(){return this.http.get(`${this.baseUrl}/users`)}registerUser(t,e){let r={email:t,password:e};return this.http.post(`${this.baseUrl}/register`,r,{headers:new C({"Content-Type":"application/json"})})}getAllUsers(){return this.http.get(`${this.baseUrl}/users`)}clearUserData(){this.isLoggedSubject.next(!1),localStorage.removeItem("userID"),localStorage.removeItem("accessToken"),sessionStorage.clear(),localStorage.removeItem("userID"),this.userIdSubject.next(null)}setUserId(t){t?localStorage.setItem("userID",t.toString()):localStorage.removeItem("userID"),this.userIdSubject.next(t)}getUserId(){return this.userIdSubject.value}static \u0275fac=function(e){return new(e||c)(p(U),p(v))};static \u0275prov=g({token:c,factory:c.\u0275fac,providedIn:"root"})};var j=class c{constructor(t,e){this.http=t;this.usersService=e;this.syncTotal(),this.usersService.userId$.subscribe(r=>{r!==null&&r===this.userId&&this.syncLocalCartWithServer()})}baseUrl="https://labairapi.onrender.com/cart";userId=null;localStorageKey="local-cart";cartItemsSubject=new u(this.getCartItemsLocal());cartItems$=this.cartItemsSubject.asObservable();totalSubject=new u(0);total$=this.totalSubject.asObservable();getCartItemsLocal(){return JSON.parse(localStorage.getItem(this.localStorageKey)||"[]")}saveCartLocal(t){localStorage.setItem(this.localStorageKey,JSON.stringify(t)),this.cartItemsSubject.next(t),this.syncTotal()}syncLocalCartWithServer(){let t=this.getUserId();if(!t)return;let e=this.getCartItemsLocal();if(e.length===0){this.syncCartWithServer();return}this.http.get(`${this.baseUrl}?userID=${t}`).pipe(n(r=>{let i=new Set,a=e.map(s=>{let l=`${s.id_product}-${s.size}-${s.color}`;if(i.has(l))return o(null);i.add(l);let S=r.find(f=>f.id_product===s.id_product&&f.size===s.size&&f.color===s.color);return S?this.http.patch(`${this.baseUrl}/${S.id}`,{quantity:S.quantity+s.quantity}):this.http.post(`${this.baseUrl}`,b(d({},s),{userID:t}))});return y(a.filter(s=>s!==o(null)))}),n(()=>this.getCartItems())).subscribe(r=>{this.cartItemsSubject.next(r),this.clearCartLocal()})}syncCartWithServer(){let t=this.getUserId();t&&this.http.get(this.baseUrl).pipe(h(e=>e.filter(r=>r.userID===t)),m(()=>o([]))).subscribe(e=>{this.saveCartLocal(e)})}addToCart(t){let e=this.getUserId(),r=this.getCartItemsLocal(),i=r.findIndex(a=>a.id_product===t.id_product&&a.size===t.size&&a.color===t.color);i!==-1?r[i].quantity+=1:r.push(b(d({},t),{quantity:1})),this.saveCartLocal(r),e&&this.http.get(`${this.baseUrl}?userID=${e}`).pipe(h(a=>a.find(s=>s.id_product===t.id_product&&s.size===t.size&&s.color===t.color)),n(a=>a?this.http.patch(`${this.baseUrl}/${a.id}`,{quantity:a.quantity+1}):this.http.post(`${this.baseUrl}`,b(d({},t),{userID:e,quantity:1})))).subscribe(()=>{this.syncCartWithServer()})}removeFromCart(t){let e=this.getUserId();e&&this.http.get(this.baseUrl).pipe(h(i=>i.find(a=>a.userID===e&&a.id_product===t.id_product&&a.size===t.size)),n(i=>i?this.http.delete(`${this.baseUrl}/${i.id}`):o(null)),n(()=>this.getCartItems())).subscribe(i=>{this.cartItemsSubject.next(i)});let r=this.getCartItemsLocal().filter(i=>i.id_product!==t.id_product||i.size!==t.size);this.saveCartLocal(r)}updateQuantityLocal(t,e){let r=this.getUserId(),i=this.getCartItemsLocal(),a=i.findIndex(s=>s.id_product===t.id_product&&s.size===t.size&&s.color===t.color);a!==-1&&(i[a].quantity=e?i[a].quantity+1:Math.max(1,i[a].quantity-1)),this.saveCartLocal(i),r&&this.http.get(`${this.baseUrl}?userID=${r}`).pipe(h(s=>s.find(l=>l.id_product===t.id_product&&l.size===t.size&&l.color===t.color)),n(s=>s?this.http.patch(`${this.baseUrl}/${s.id}`,{quantity:e?s.quantity+1:Math.max(1,s.quantity-1)}):o(null))).subscribe(()=>{this.syncCartWithServer()})}clearCartLocal(){let t=this.getUserId();localStorage.removeItem(this.localStorageKey),this.cartItemsSubject.next([]),this.syncTotal(),t&&this.syncCartWithServer()}getCartItems(){let t=this.getUserId();return t?this.http.get(this.baseUrl).pipe(h(e=>e.filter(r=>r.userID===t)),m(()=>o([]))):o(this.getCartItemsLocal())}syncCartItems(){this.getCartItems().subscribe(t=>this.cartItemsSubject.next(t)),this.syncTotal()}syncTotal(){let t=this.getCartItemsLocal().reduce((e,r)=>e+r.price*r.quantity,0);this.totalSubject.next(t)}getUserId(){return this.usersService.getUserId()}clearCart(){this.cartItemsSubject.next([])}static \u0275fac=function(e){return new(e||c)(p(v),p(I))};static \u0275prov=g({token:c,factory:c.\u0275fac,providedIn:"root"})};export{I as a,j as b};
